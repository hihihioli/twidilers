{% extends 'base.html' %}
{% block title %}Feed{% endblock %}
{% block head %}
<link rel="stylesheet" data-turbo-track="dynamic" href="{{ url_for('.static', filename='styles/post.css') }}">
<link rel="stylesheet" data-turbo-track="dynamic" href="{{ url_for('.static', filename='styles/toggle.css') }}">
{% endblock %}

{% block content %}
<main>
    <div id="topfeed" role="region" aria-label="Feed controls">
        <h1 id="feedtitle">Your feed</h1>
        <a href="{{ url_for('.write_post') }}" role="button" class="submit" id="createpost" aria-label="Create a new post">Create a Post</a>
        
        <button id="filter" 
                onclick="flyOut('filter-form','filter')" 
                aria-expanded="false"
                aria-controls="filter-form"
                aria-label="Toggle feed filters">
            <i class="fa-solid fa-filter" aria-hidden="true"></i>
            <span class="visually-hidden">Filter posts</span>
        </button>

        <form method="post" id="filter-form" name="filter-form" aria-label="Feed filter options">
            <div class="filter-control">
                <label class="switch" for="filter-foll">
                    <input type="checkbox" 
                           id="filter-foll" 
                           name="filter-foll" 
                           {% if session['filter'] == 1 %}checked{% endif %}
                           aria-label="Show only followed users">
                    <span class="slider round" aria-hidden="true"></span>
                </label>
                <span class="checkbox-label">Show only posts from people I follow</span>
            </div>
            <button id="submit-filter" type="submit" class="submit">Apply Filters</button>
        </form>
    </div>

    {% if postlist() | length > 0 %}
    <section aria-label="Posts feed" class="posts-container">
        {% set account = findAccount() %}
        {% for post in postlist() %}
        {% if session['filter'] == 0 or post.author in account.following %}
        <article class="pst" aria-labelledby="post-title-{{ loop.index }}">
            <header>
                <a href="{{ url_for('.profile',username=post.author.username) }}" 
                   class="auth-info"
                   aria-label="View {{ post.author.displayname }}'s profile">
                    <img class="pst-auth-pfp" 
                         loading="lazy" 
                         src="{{ url_for('.get_pfp', username=post.author.username) }}"
                         alt="Profile picture of {{ post.author.displayname }}">
                    <div class="pst-auths">
                        <p class="pst-auth">{{post.author.displayname}}</p>
                        <p class="pst-disp">@{{post.author.username}}</p>              
                    </div>
                </a>
            </header>

            <div class="reactions" role="toolbar" aria-label="Post actions">
                {% if owner == 1 %}
                <button class="edit-post" aria-label="Edit post">
                    <i class="fa-solid fa-pencil" aria-hidden="true"></i>
                    <span class="visually-hidden">Edit this post</span>
                </button>
                {% endif %}
            </div>

            <h2 class="pst-title" id="post-title-{{ loop.index }}">{{post.title}}</h2>
            <p class="pst-content">{{post.content}}</p>
            <time class="pst-date" id="date{{ loop.index0 }}" datetime="{{ post.date }}">
                {{ post.date | format_date }}
            </time>
        </article>
        {% endif %}
        {% endfor %}
    </section>
    {% else %}
    <p class="no-posts">No posts to display</p>
    {% endif %}
</main>
<script src="{{ url_for('.static', filename='/javascript/flyout.js') }}">
</script>
{% endblock %}